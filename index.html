<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gazan System - إدارة المبيعات والمديونين والاشتراكات</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            transition: all 0.3s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #9b59b6;
            --secondary-dark: #8e44ad;
            --success: #2ecc71;
            --success-dark: #27ae60;
            --warning: #f39c12;
            --warning-dark: #e67e22;
            --danger: #e74c3c;
            --danger-dark: #c0392b;
            --info: #00bcd4;
            --info-dark: #0097a7;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --border: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.1);
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        body.dark-mode {
            --primary: #3a86ff;
            --primary-dark: #2667cc;
            --secondary: #9d4edd;
            --secondary-dark: #7b2cbf;
            --success: #4cc9f0;
            --success-dark: #4895ef;
            --warning: #f8961e;
            --warning-dark: #f3722c;
            --danger: #f94144;
            --danger-dark: #d00000;
            --info: #00e5ff;
            --info-dark: #00bcd4;
            --light: #1a1a2e;
            --dark: #f8f9fa;
            --gray: #b0b0b0;
            --border: #2d3748;
            --shadow: rgba(0, 0, 0, 0.3);
            --bg-gradient: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        }
        
        body {
            background: var(--bg-gradient);
            padding: 20px;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light);
            border-radius: 20px;
            box-shadow: 0 15px 40px var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--dark), #34495e);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 { 
            font-size: 2.2em; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .theme-toggle {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Page Navigation */
        .page-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .page-btn {
            padding: 10px 25px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--dark);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn.info { border-color: var(--info); }
        .page-btn.info.active { background: var(--info); border-color: var(--info); }
        .page-btn.info:hover { background: var(--info); border-color: var(--info); }
        
        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            padding: 30px;
            background: var(--light);
        }
        
        .stat-card {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px var(--shadow);
            text-align: center;
            border-left: 5px solid;
            border: 1px solid var(--border);
        }
        
        .stat-card.blue { border-color: var(--primary); }
        .stat-card.purple { border-color: var(--secondary); }
        .stat-card.green { border-color: var(--success); }
        .stat-card.orange { border-color: var(--warning); }
        .stat-card.red { border-color: var(--danger); }
        .stat-card.info { border-color: var(--info); }
        
        .stat-number { 
            font-size: 2.5em; 
            font-weight: bold; 
            margin: 10px 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .blue-text { color: var(--primary); }
        .purple-text { color: var(--secondary); }
        .green-text { color: var(--success); }
        .orange-text { color: var(--warning); }
        .red-text { color: var(--danger); }
        .info-text { color: var(--info); }
        
        /* Page Content */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Controls Section */
        .controls {
            padding: 30px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
        }
        
        .product-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .subscription-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .duration-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .duration-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
            background: var(--light);
        }
        
        .duration-option:hover {
            background: rgba(0, 188, 212, 0.1);
        }
        
        .duration-option.selected {
            border-color: var(--info);
            background: rgba(0, 188, 212, 0.1);
        }
        
        .duration-radio {
            display: none;
        }
        
        .duration-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .radio-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .duration-radio:checked + .duration-label .radio-custom {
            border-color: var(--info);
            background: var(--info);
        }
        
        .duration-radio:checked + .duration-label .radio-custom::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }
        
        .duration-icon {
            font-size: 1.2em;
            color: var(--info);
        }
        
        .payment-options {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .payment-option:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .payment-option.selected {
            border-color: var(--primary);
            background: rgba(52, 152, 219, 0.1);
        }
        
        .payment-option.flexy.selected {
            border-color: var(--secondary);
            background: rgba(155, 89, 182, 0.1);
        }
        
        .payment-radio {
            display: none;
        }
        
        .payment-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .payment-radio:checked + .payment-label .radio-custom {
            border-color: var(--primary);
            background: var(--primary);
        }
        
        .payment-radio:checked + .payment-label .radio-custom::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }
        
        .payment-radio:checked + .payment-label.flexy .radio-custom {
            border-color: var(--secondary);
            background: var(--secondary);
        }
        
        .payment-icon {
            font-size: 1.2em;
        }
        
        .normal-icon {
            color: var(--primary);
        }
        
        .flexy-icon {
            color: var(--secondary);
        }
        
        .add-btn-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .add-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        .add-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        /* Price Display */
        .price-display {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid var(--border);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subscription-dates {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid var(--border);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        
        .flexy-price { color: var(--secondary); font-weight: bold; }
        .normal-price { color: var(--primary); font-weight: bold; }
        .info-price { color: var(--info); font-weight: bold; }
        .profit-display { color: var(--success); font-weight: bold; font-size: 1.2em; }
        
        /* Transactions Section */
        .transactions {
            padding: 30px;
            background: var(--light);
        }
        
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .transaction-table-wrapper, .debts-table-wrapper, .subscriptions-table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        
        .transaction-table, .debts-table, .subscriptions-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .transaction-table th, .transaction-table td,
        .debts-table th, .debts-table td,
        .subscriptions-table th, .subscriptions-table td {
            padding: 16px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .transaction-table th, .debts-table th, .subscriptions-table th {
            background: var(--dark);
            color: var(--light);
            position: relative;
            cursor: pointer;
        }
        
        .transaction-table th:hover, .debts-table th:hover, .subscriptions-table th:hover {
            background: #34495e;
        }
        
        .normal { border-left: 4px solid var(--primary); }
        .flexy { border-left: 4px solid var(--secondary); }
        .subscription-row { border-left: 4px solid var(--info); }
        
        .type-badge {
            padding: 6px 15px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        .type-normal { background: var(--primary); }
        .type-flexy { background: var(--secondary); }
        .type-subscription { background: var(--info); }
        
        .duration-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }
        
        .duration-1 { background: linear-gradient(45deg, var(--info), #2196f3); color: white; }
        .duration-2 { background: linear-gradient(45deg, var(--info), #00bcd4); color: white; }
        .duration-3 { background: linear-gradient(45deg, var(--info), #0097a7); color: white; }
        .duration-6 { background: linear-gradient(45deg, var(--info), #006064); color: white; }
        .duration-12 { background: linear-gradient(45deg, var(--info), #004d40); color: white; }
        
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-active { background: linear-gradient(45deg, var(--success), var(--success-dark)); color: white; }
        .status-expired { background: linear-gradient(45deg, var(--danger), var(--danger-dark)); color: white; }
        .status-soon { background: linear-gradient(45deg, var(--warning), var(--warning-dark)); color: white; }
        
        .product-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            cursor: pointer;
        }
        
        .subscription-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
            background: linear-gradient(45deg, var(--info), var(--info-dark));
            color: white;
            cursor: pointer;
        }
        
        .profit-cell {
            cursor: pointer;
            font-weight: bold;
            position: relative;
        }
        
        .profit-cell:hover {
            background: rgba(46, 204, 113, 0.1);
        }
        
        .debtor-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin: 2px;
            background: linear-gradient(45deg, var(--danger), var(--danger-dark));
            color: white;
            cursor: pointer;
        }
        
        .debtor-badge.paid {
            background: linear-gradient(45deg, var(--success), var(--success-dark));
        }
        
        .amount-cell {
            cursor: pointer;
            font-weight: bold;
        }
        
        .amount-cell:hover {
            background: rgba(231, 76, 60, 0.1);
        }
        
        .date-cell {
            cursor: pointer;
            font-family: monospace;
        }
        
        .date-cell:hover {
            background: rgba(155, 89, 182, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            min-width: 70px;
            justify-content: center;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .edit-btn {
            background: var(--primary);
        }
        
        .edit-btn:hover {
            background: var(--primary-dark);
        }
        
        .delete-btn {
            background: var(--danger);
        }
        
        .delete-btn:hover {
            background: var(--danger-dark);
        }
        
        .update-btn {
            background: var(--warning);
        }
        
        .update-btn:hover {
            background: var(--warning-dark);
        }
        
        .renew-btn {
            background: var(--success);
        }
        
        .renew-btn:hover {
            background: var(--success-dark);
        }
        
        .profit-btn {
            background: var(--success);
        }
        
        .profit-btn:hover {
            background: var(--success-dark);
        }
        
        .info-btn {
            background: var(--info);
        }
        
        .info-btn:hover {
            background: var(--info-dark);
        }
        
        /* More Button Styles */
        .more-btn-container {
            position: relative;
            display: inline-block;
        }
        
        .more-btn {
            background: var(--secondary);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .more-btn:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.3);
        }
        
        .more-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 5px;
        }
        
        .more-options.show {
            display: flex;
        }
        
        .option-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: var(--light);
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            text-align: right;
            font-size: 14px;
            font-weight: 500;
        }
        
        .option-btn:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .option-btn.export {
            color: var(--success);
        }
        
        .option-btn.import {
            color: var(--primary);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
            animation-fill-mode: forwards;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-info { background: var(--primary); }
        .toast-warning { background: var(--warning); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--light);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        /* Checkbox */
        .select-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .product-form { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .product-form, .subscription-form { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .header h1 { font-size: 1.8em; }
            .stat-number { font-size: 2em; }
            .payment-options, .duration-options { flex-direction: column; }
            .transaction-table, .debts-table, .subscriptions-table { min-width: 600px; }
            .action-buttons { flex-direction: column; }
            .more-btn { padding: 10px 15px; }
            .more-options { min-width: 180px; }
        }
        
        @media (max-width: 480px) {
            body { padding: 10px; }
            .container { border-radius: 15px; }
            .header, .controls, .transactions { padding: 20px 15px; }
            .stats-grid { padding: 20px 15px; grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .more-btn-container { width: 100%; }
            .more-btn { width: 100%; justify-content: center; }
            .more-options { width: 100%; }
        }
        
        input, select, button {
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--light);
            color: var(--dark);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }
        
        .clear-btn { 
            background: var(--danger); 
        }
        
        .clear-btn:hover { 
            background: var(--danger-dark); 
        }
        
        .export-btn {
            background: var(--success);
        }
        
        .export-btn:hover {
            background: var(--success-dark);
        }
        
        .info-btn {
            background: var(--info);
        }
        
        .info-btn:hover {
            background: var(--info-dark);
        }
        
        /* Quick Profit Menu */
        .profit-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 5px 20px var(--shadow);
            z-index: 100;
            display: none;
        }
        
        .profit-menu.show {
            display: block;
        }
        
        .profit-option {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }
        
        .profit-option:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        /* Debts Page Specific */
        .debts-controls {
            padding: 30px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
        }
        
        .debt-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* Subscriptions Page Specific */
        .subscriptions-controls {
            padding: 30px;
            background: var(--light);
            border-bottom: 1px solid var(--border);
        }
        
        @media (max-width: 768px) {
            .debt-form { grid-template-columns: 1fr; }
        }
        
        /* Date Picker */
        .date-input {
            font-family: monospace;
        }
        
        /* New Edit Modals */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .edit-modal-content {
            background: var(--light);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .edit-modal-title {
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .edit-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        .edit-form-group {
            margin-bottom: 20px;
        }
        
        .edit-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark);
        }
        
        .edit-form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--light);
            color: var(--dark);
            font-size: 16px;
        }
        
        .edit-form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .date-edit-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .date-edit-container input {
            flex: 1;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
            <h1><i class="fas fa-rocket"></i> Gazan System</h1>
            <p>إدارة المبيعات والمديونين والاشتراكات</p>
        </div>
        
        <!-- Page Navigation -->
        <div class="page-nav">
            <button class="page-btn active" onclick="showPage('sales')">المبيعات</button>
            <button class="page-btn" onclick="showPage('debts')">المديونين</button>
            <button class="page-btn info" onclick="showPage('subscriptions')">الاشتراكات</button>
        </div>
        
        <!-- Sales Page -->
        <div id="sales-page" class="page-content active">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card blue">
                    <h3><i class="fas fa-money-bill-wave"></i> المبيعات العادية</h3>
                    <div class="stat-number blue-text" id="normalSales">0 دينار</div>
                    <p id="normalCount">0 عملية بيع</p>
                </div>
                <div class="stat-card purple">
                    <h3><i class="fas fa-credit-card"></i> مبيعات فليكسي</h3>
                    <div class="stat-number purple-text" id="flexySales">0 دينار</div>
                    <p id="flexyCount">0 عملية بيع</p>
                </div>
                <div class="stat-card green">
                    <h3><i class="fas fa-chart-line"></i> الربح اليومي</h3>
                    <div class="stat-number green-text" id="dailyProfit">0 دينار</div>
                    <p id="dailyCount">0 عملية اليوم</p>
                </div>
                <div class="stat-card orange">
                    <h3><i class="fas fa-calendar-alt"></i> الربح الشهري</h3>
                    <div class="stat-number orange-text" id="monthlyProfit">0 دينار</div>
                    <p id="monthlyCount">0 عملية هذا الشهر</p>
                </div>
            </div>
            
            <!-- Add Transaction -->
            <div class="controls">
                <h3><i class="fas fa-plus-circle"></i> إضافة عملية بيع جديدة</h3>
                
                <!-- Product Name -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="productName" placeholder="اسم المنتج (مثال: MLBB ماس، FF ماس، إلخ)" style="width: 100%;">
                </div>
                
                <!-- Price Inputs -->
                <div class="product-form">
                    <input type="number" id="usdPrice" placeholder="سعر الدولار ($)" step="0.01" oninput="calculateProfit()">
                    <input type="number" id="exchangeRate" value="255" placeholder="سعر الصرف" step="0.01" oninput="calculateProfit()">
                    <input type="number" id="productPrice" placeholder="سعر المنتج (دينار)" step="0.01" oninput="calculateProfit()">
                </div>
                
                <!-- Payment Options -->
                <div class="payment-options">
                    <div class="payment-option normal selected" onclick="selectPaymentType('normal')" id="normalOption">
                        <input type="radio" name="paymentType" value="normal" id="normalPayment" class="payment-radio" checked>
                        <label for="normalPayment" class="payment-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-money-bill-wave payment-icon normal-icon"></i>
                            <span>دفع عادي</span>
                        </label>
                    </div>
                    
                    <div class="payment-option flexy" onclick="selectPaymentType('flexy')" id="flexyOption">
                        <input type="radio" name="paymentType" value="flexy" id="flexyPayment" class="payment-radio">
                        <label for="flexyPayment" class="payment-label flexy">
                            <span class="radio-custom"></span>
                            <i class="fas fa-credit-card payment-icon flexy-icon"></i>
                            <span>دفع فليكسي</span>
                        </label>
                    </div>
                </div>
                
                <!-- Add Button -->
                <div class="add-btn-container">
                    <button class="add-btn" onclick="addTransaction()">
                        <i class="fas fa-plus-circle"></i>
                        إضافة العملية
                    </button>
                </div>
                
                <!-- Price Calculation Display -->
                <div class="price-display">
                    <div id="profitCalculation">
                        <div style="color: var(--gray);">
                            <i class="fas fa-arrow-left"></i> أدخل الأسعار لرؤية حساب الربح
                        </div>
                    </div>
                </div>
                
                <!-- Sales Action Buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="clear-btn" onclick="clearSalesData()">
                        <i class="fas fa-trash"></i> مسح بيانات المبيعات
                    </button>
                    
                    <div class="more-btn-container">
                        <button class="more-btn" onclick="toggleMoreOptions('sales')">
                            <i class="fas fa-ellipsis-h"></i> المزيد
                        </button>
                        <div class="more-options" id="salesMoreOptions">
                            <button class="option-btn export" onclick="exportSalesData()">
                                <i class="fas fa-file-export"></i> تصدير المبيعات
                            </button>
                            <button class="option-btn import" onclick="importSalesData()">
                                <i class="fas fa-file-import"></i> استيراد المبيعات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Transactions Table -->
            <div class="transactions">
                <div class="table-controls">
                    <div class="selection-controls">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="select-checkbox">
                        <label for="selectAll">تحديد الكل</label>
                        <button onclick="deleteSelectedSales()" class="clear-btn" style="padding: 8px 15px; font-size: 14px;">
                            <i class="fas fa-trash"></i> حذف المحدد
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="salesSearchInput" placeholder="ابحث في المبيعات..." style="width: 100%;" oninput="filterSalesTable()">
                    </div>
                </div>
                
                <div class="transaction-table-wrapper">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()"></th>
                                <th onclick="sortSalesTable('productName')">المنتج</th>
                                <th onclick="sortSalesTable('type')">النوع</th>
                                <th onclick="sortSalesTable('usdPrice')">سعر $</th>
                                <th onclick="sortSalesTable('cost')">التكلفة</th>
                                <th onclick="sortSalesTable('productPrice')">سعر المنتج</th>
                                <th onclick="sortSalesTable('profit')">الربح</th>
                                <th onclick="sortSalesTable('date')">التاريخ</th>
                                <th style="width: 200px;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Debts Page -->
        <div id="debts-page" class="page-content">
            <!-- Debts Statistics -->
            <div class="stats-grid">
                <div class="stat-card red">
                    <h3><i class="fas fa-users"></i> إجمالي المديونين</h3>
                    <div class="stat-number red-text" id="totalDebtors">0 شخص</div>
                    <p id="activeDebts">0 دين نشط</p>
                </div>
                <div class="stat-card orange">
                    <h3><i class="fas fa-money-bill-wave"></i> إجمالي الديون</h3>
                    <div class="stat-number orange-text" id="totalDebts">0 دينار</div>
                    <p id="averageDebt">0 متوسط الدين</p>
                </div>
                <div class="stat-card green">
                    <h3><i class="fas fa-money-bill"></i> الديون المسددة</h3>
                    <div class="stat-number green-text" id="paidCount">0 دين</div>
                    <p>ديون تم سدادها بالكامل</p>
                </div>
            </div>
            
            <!-- Add Debt -->
            <div class="debts-controls">
                <h3><i class="fas fa-user-plus"></i> إضافة مديون جديد</h3>
                
                <div class="debt-form">
                    <input type="text" id="debtorName" placeholder="اسم المديون" style="width: 100%;">
                    <input type="number" id="debtAmount" placeholder="مبلغ الدين (دينار)" step="0.01">
                    <button class="add-btn" onclick="addDebt()" style="min-width: auto;">
                        <i class="fas fa-plus-circle"></i>
                        إضافة
                    </button>
                </div>
                
                <!-- Debts Action Buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="clear-btn" onclick="clearAllDebts()">
                        <i class="fas fa-trash"></i> مسح جميع الديون
                    </button>
                    
                    <div class="more-btn-container">
                        <button class="more-btn" onclick="toggleMoreOptions('debts')">
                            <i class="fas fa-ellipsis-h"></i> المزيد
                        </button>
                        <div class="more-options" id="debtsMoreOptions">
                            <button class="option-btn export" onclick="exportDebts()">
                                <i class="fas fa-file-export"></i> تصدير الديون
                            </button>
                            <button class="option-btn import" onclick="importDebts()">
                                <i class="fas fa-file-import"></i> استيراد الديون
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Debts Table -->
            <div class="transactions">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="debtSearchInput" placeholder="ابحث في المدينين..." style="width: 100%;" oninput="filterDebtsTable()">
                    </div>
                </div>
                
                <div class="debts-table-wrapper">
                    <table class="debts-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th onclick="sortDebtsTable('name')">اسم المديون</th>
                                <th onclick="sortDebtsTable('amount')">مبلغ الدين</th>
                                <th onclick="sortDebtsTable('date')">التاريخ</th>
                                <th style="width: 220px;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="debtsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Subscriptions Page -->
        <div id="subscriptions-page" class="page-content">
            <!-- Subscriptions Statistics -->
            <div class="stats-grid">
                <div class="stat-card info">
                    <h3><i class="fas fa-users"></i> إجمالي المشتركين</h3>
                    <div class="stat-number info-text" id="totalSubscribers">0 مشترك</div>
                    <p id="activeSubscriptions">0 اشتراك نشط</p>
                </div>
                <div class="stat-card blue">
                    <h3><i class="fas fa-calendar-check"></i> الاشتراكات النشطة</h3>
                    <div class="stat-number blue-text" id="activeSubsCount">0 اشتراك</div>
                    <p>اشتراكات لم تنتهي صلاحيتها</p>
                </div>
                <div class="stat-card orange">
                    <h3><i class="fas fa-exclamation-triangle"></i> تنتهي قريباً</h3>
                    <div class="stat-number orange-text" id="expiringSoonCount">0 اشتراك</div>
                    <p>تنتهي خلال 7 أيام</p>
                </div>
                <div class="stat-card red">
                    <h3><i class="fas fa-calendar-times"></i> الاشتراكات المنتهية</h3>
                    <div class="stat-number red-text" id="expiredSubsCount">0 اشتراك</div>
                    <p>انتهت صلاحيتها</p>
                </div>
            </div>
            
            <!-- Add Subscription -->
            <div class="subscriptions-controls">
                <h3><i class="fas fa-user-plus"></i> إضافة اشتراك جديد</h3>
                
                <div class="subscription-form">
                    <input type="text" id="subscriptionName" placeholder="اسم الاشتراك (مثال: نتفلكس، سبوتيفاي)" style="width: 100%;">
                    <input type="text" id="subscriberName" placeholder="اسم المشترك" style="width: 100%;">
                </div>
                
                <!-- Duration Options -->
                <div class="duration-options">
                    <div class="duration-option selected" onclick="selectDuration(1)" id="duration1Option">
                        <input type="radio" name="duration" value="1" id="duration1" class="duration-radio" checked>
                        <label for="duration1" class="duration-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-calendar-day duration-icon"></i>
                            <span>شهر واحد</span>
                        </label>
                    </div>
                    
                    <div class="duration-option" onclick="selectDuration(2)" id="duration2Option">
                        <input type="radio" name="duration" value="2" id="duration2" class="duration-radio">
                        <label for="duration2" class="duration-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-calendar-alt duration-icon"></i>
                            <span>شهرين</span>
                        </label>
                    </div>
                    
                    <div class="duration-option" onclick="selectDuration(3)" id="duration3Option">
                        <input type="radio" name="duration" value="3" id="duration3" class="duration-radio">
                        <label for="duration3" class="duration-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-calendar duration-icon"></i>
                            <span>3 أشهر</span>
                        </label>
                    </div>
                    
                    <div class="duration-option" onclick="selectDuration(6)" id="duration6Option">
                        <input type="radio" name="duration" value="6" id="duration6" class="duration-radio">
                        <label for="duration6" class="duration-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-calendar-check duration-icon"></i>
                            <span>6 أشهر</span>
                        </label>
                    </div>
                    
                    <div class="duration-option" onclick="selectDuration(12)" id="duration12Option">
                        <input type="radio" name="duration" value="12" id="duration12" class="duration-radio">
                        <label for="duration12" class="duration-label">
                            <span class="radio-custom"></span>
                            <i class="fas fa-calendar-star duration-icon"></i>
                            <span>سنة كاملة</span>
                        </label>
                    </div>
                </div>
                
                <!-- Add Button -->
                <div class="add-btn-container">
                    <button class="add-btn" onclick="addSubscription()" style="background: var(--info);">
                        <i class="fas fa-plus-circle"></i>
                        إضافة الاشتراك
                    </button>
                </div>
                
                <!-- Dates Display -->
                <div class="subscription-dates" id="subscriptionDatesDisplay">
                    <div style="color: var(--gray);">
                        <i class="fas fa-arrow-left"></i> أدخل بيانات الاشتراك لرؤية تواريخ البدء والانتهاء
                    </div>
                </div>
                
                <!-- Subscriptions Action Buttons -->
                <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="clear-btn" onclick="clearAllSubscriptions()">
                        <i class="fas fa-trash"></i> مسح جميع الاشتراكات
                    </button>
                    
                    <div class="more-btn-container">
                        <button class="more-btn info-btn" onclick="toggleMoreOptions('subscriptions')">
                            <i class="fas fa-ellipsis-h"></i> المزيد
                        </button>
                        <div class="more-options" id="subscriptionsMoreOptions">
                            <button class="option-btn export" onclick="exportSubscriptions()">
                                <i class="fas fa-file-export"></i> تصدير الاشتراكات
                            </button>
                            <button class="option-btn import" onclick="importSubscriptions()">
                                <i class="fas fa-file-import"></i> استيراد الاشتراكات
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Subscriptions Table -->
            <div class="transactions">
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="subscriptionSearchInput" placeholder="ابحث في الاشتراكات..." style="width: 100%;" oninput="filterSubscriptionsTable()">
                    </div>
                </div>
                
                <div class="subscriptions-table-wrapper">
                    <table class="subscriptions-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th onclick="sortSubscriptionsTable('subscriptionName')">اسم الاشتراك</th>
                                <th onclick="sortSubscriptionsTable('subscriberName')">اسم المشترك</th>
                                <th onclick="sortSubscriptionsTable('duration')">المدة</th>
                                <th onclick="sortSubscriptionsTable('startDate')">تاريخ البدء</th>
                                <th onclick="sortSubscriptionsTable('endDate')">تاريخ الانتهاء</th>
                                <th onclick="sortSubscriptionsTable('status')">الحالة</th>
                                <th style="width: 250px;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptionsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Quick Profit Menu -->
    <div class="profit-menu" id="profitMenu">
        <div class="profit-option" onclick="addQuickProfit(50)">+50 دينار</div>
        <div class="profit-option" onclick="addQuickProfit(100)">+100 دينار</div>
        <div class="profit-option" onclick="addQuickProfit(200)">+200 دينار</div>
        <div class="profit-option" onclick="addQuickProfit(500)">+500 دينار</div>
        <div class="profit-option" onclick="addQuickProfit(-50)">-50 دينار</div>
        <div class="profit-option" onclick="addQuickProfit(-100)">-100 دينار</div>
        <div class="profit-option" onclick="openCustomProfitModal()">مبلغ مخصص</div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="customProfitModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> إضافة ربح مخصص</h3>
            <div style="margin-bottom: 20px;">
                <label>المبلغ (استخدم + للزيادة و - للنقصان):</label>
                <input type="text" id="customProfitAmount" placeholder="مثال: +100 أو -50" style="width: 100%; margin-top: 5px;">
            </div>
            <div class="modal-actions">
                <button onclick="saveCustomProfit()" class="export-btn"><i class="fas fa-check"></i> تطبيق</button>
                <button onclick="closeCustomProfitModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="updateDebtModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-exchange-alt"></i> تحديث مبلغ الدين</h3>
            <div id="updateDebtModalContent"></div>
            <div class="modal-actions">
                <button onclick="saveDebtUpdate()" class="export-btn"><i class="fas fa-check"></i> تطبيق</button>
                <button onclick="closeUpdateDebtModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addProfitModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-money-bill"></i> إضافة ربح جديد</h3>
            <div id="addProfitModalContent"></div>
            <div class="modal-actions">
                <button onclick="saveNewProfit()" class="export-btn"><i class="fas fa-check"></i> تطبيق</button>
                <button onclick="closeAddProfitModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="renewSubscriptionModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-redo"></i> تجديد الاشتراك</h3>
            <div id="renewSubscriptionModalContent"></div>
            <div class="modal-actions">
                <button onclick="saveRenewal()" class="export-btn"><i class="fas fa-check"></i> تجديد</button>
                <button onclick="closeRenewSubscriptionModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <!-- New Edit Modals -->
    <div class="edit-modal" id="editProductModal">
        <div class="edit-modal-content">
            <h3 class="edit-modal-title"><i class="fas fa-edit"></i> تعديل اسم المنتج</h3>
            <div class="edit-form-group">
                <label>اسم المنتج الجديد:</label>
                <input type="text" id="editProductNameInput" placeholder="أدخل الاسم الجديد">
            </div>
            <div class="edit-modal-actions">
                <button onclick="saveEditProduct()" class="export-btn"><i class="fas fa-check"></i> حفظ</button>
                <button onclick="closeEditProductModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="edit-modal" id="editDebtorModal">
        <div class="edit-modal-content">
            <h3 class="edit-modal-title"><i class="fas fa-user-edit"></i> تعديل اسم المديون</h3>
            <div class="edit-form-group">
                <label>اسم المديون الجديد:</label>
                <input type="text" id="editDebtorNameInput" placeholder="أدخل الاسم الجديد">
            </div>
            <div class="edit-modal-actions">
                <button onclick="saveEditDebtor()" class="export-btn"><i class="fas fa-check"></i> حفظ</button>
                <button onclick="closeEditDebtorModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="edit-modal" id="editSubscriptionModal">
        <div class="edit-modal-content">
            <h3 class="edit-modal-title"><i class="fas fa-edit"></i> تعديل اسم الاشتراك</h3>
            <div class="edit-form-group">
                <label>اسم الاشتراك الجديد:</label>
                <input type="text" id="editSubscriptionNameInput" placeholder="أدخل الاسم الجديد">
            </div>
            <div class="edit-modal-actions">
                <button onclick="saveEditSubscription()" class="export-btn"><i class="fas fa-check"></i> حفظ</button>
                <button onclick="closeEditSubscriptionModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="edit-modal" id="editSubscriberModal">
        <div class="edit-modal-content">
            <h3 class="edit-modal-title"><i class="fas fa-user-edit"></i> تعديل اسم المشترك</h3>
            <div class="edit-form-group">
                <label>اسم المشترك الجديد:</label>
                <input type="text" id="editSubscriberNameInput" placeholder="أدخل الاسم الجديد">
            </div>
            <div class="edit-modal-actions">
                <button onclick="saveEditSubscriber()" class="export-btn"><i class="fas fa-check"></i> حفظ</button>
                <button onclick="closeEditSubscriberModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>
    
    <div class="edit-modal" id="editSubscriptionDatesModal">
        <div class="edit-modal-content">
            <h3 class="edit-modal-title"><i class="fas fa-calendar-edit"></i> تعديل تواريخ الاشتراك</h3>
            <div class="edit-form-group">
                <label>تاريخ البدء (YYYY/MM/DD):</label>
                <input type="text" id="editStartDateInput" placeholder="مثال: 2024/01/15" class="date-input">
            </div>
            <div class="edit-form-group">
                <label>المدة:</label>
                <select id="editDurationInput" style="width: 100%;">
                    <option value="1">شهر واحد</option>
                    <option value="2">شهرين</option>
                    <option value="3">3 أشهر</option>
                    <option value="6">6 أشهر</option>
                    <option value="12">سنة كاملة</option>
                </select>
            </div>
            <div id="newEndDateDisplay" style="margin: 15px 0; padding: 10px; background: var(--border); border-radius: 8px; text-align: center;">
                <strong>تاريخ الانتهاء: <span id="calculatedEndDate">-</span></strong>
            </div>
            <div class="edit-modal-actions">
                <button onclick="saveEditSubscriptionDates()" class="export-btn"><i class="fas fa-check"></i> حفظ</button>
                <button onclick="closeEditSubscriptionDatesModal()" class="clear-btn"><i class="fas fa-times"></i> إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        console.log("🚀 بدء Gazan System...");
        
        // البيانات الرئيسية
        let exchangeRate = 255;
        let currentProfitId = null;
        let currentDebtorId = null;
        let currentTransactionId = null;
        let currentSubscriptionId = null;
        let profitMenuOpen = false;
        let paymentType = 'normal';
        let subscriptionDuration = 1;
        let paidDebtsCount = 0;
        
        // متغيرات للتعديل
        let editingProductId = null;
        let editingDebtorId = null;
        let editingSubscriptionId = null;
        let editingSubscriberId = null;
        let editingSubscriptionDatesId = null;
        
        // تخزين البيانات
        let transactions = JSON.parse(localStorage.getItem('salesTransactions')) || [];
        let debts = JSON.parse(localStorage.getItem('debtsData')) || [];
        let subscriptions = JSON.parse(localStorage.getItem('subscriptionsData')) || [];
        
        // إعدادات العرض
        let currentPage = 'sales';
        let salesSortColumn = 'timestamp';
        let salesSortDirection = 'desc';
        let debtSortColumn = 'timestamp';
        let debtSortDirection = 'desc';
        let subscriptionSortColumn = 'timestamp';
        let subscriptionSortDirection = 'desc';
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("✅ Gazan System جاهز");
            loadThemePreference();
            loadData();
            showPage('sales');
            
            // إغلاق القوائم عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.profit-cell') && !e.target.closest('.profit-menu')) {
                    hideProfitMenu();
                }
                if (!e.target.closest('.more-btn-container')) {
                    document.getElementById('salesMoreOptions').classList.remove('show');
                    document.getElementById('debtsMoreOptions').classList.remove('show');
                    document.getElementById('subscriptionsMoreOptions').classList.remove('show');
                }
            });
            
            // تحديث عرض تواريخ الاشتراك عند تغيير المدة
            document.querySelectorAll('.duration-option').forEach(option => {
                option.addEventListener('click', updateSubscriptionDates);
            });
            
            // تحديث تاريخ الانتهاء عند تعديل التواريخ
            document.getElementById('editStartDateInput').addEventListener('input', updateCalculatedEndDate);
            document.getElementById('editDurationInput').addEventListener('change', updateCalculatedEndDate);
        });
        
        // === وظائف التنقل ===
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.page-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(page + '-page').classList.add('active');
            document.querySelector(`.page-btn[onclick*="${page}"]`).classList.add('active');
            
            currentPage = page;
            
            if (page === 'sales') {
                updateSales();
            } else if (page === 'debts') {
                updateDebts();
            } else if (page === 'subscriptions') {
                updateSubscriptions();
            }
        }
        
        // === وظائف المبيعات ===
        function loadData() {
            updateSales();
            updateDebts();
            updateSubscriptions();
            checkForZeroDebts();
        }
        
        function selectPaymentType(type) {
            paymentType = type;
            document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
            document.getElementById(type + 'Option').classList.add('selected');
            document.getElementById(type + 'Payment').checked = true;
            calculateProfit();
        }
        
        function calculateProfit() {
            const usdPrice = parseFloat(document.getElementById('usdPrice').value) || 0;
            const rate = parseFloat(document.getElementById('exchangeRate').value) || exchangeRate;
            const productPrice = parseFloat(document.getElementById('productPrice').value) || 0;
            
            if (!usdPrice || !productPrice) {
                document.getElementById('profitCalculation').innerHTML = 
                    '<div style="color: var(--gray);"><i class="fas fa-arrow-left"></i> أدخل الأسعار لرؤية حساب الربح</div>';
                return;
            }
            
            exchangeRate = rate;
            
            if (paymentType === 'flexy') {
                // حساب فليكسي - خطوة بخطوة كما وصفتها
                // 1. تحويل سعر المنتج من الدولار للدينار
                const productCost = usdPrice * rate;
                
                // 2. المبلغ الصافي بعد خصم فليكسي 18%
                const netAmount = productPrice * 0.82;
                
                // 3. الربح النهائي
                let profit = netAmount - productCost;
                
                document.getElementById('profitCalculation').innerHTML = `
                    <div><i class="fas fa-dollar-sign normal-price"></i> <span class="normal-price">التكلفة:</span> ${formatNumber(productCost)} دينار (${usdPrice}$ × ${rate})</div>
                    <div><i class="fas fa-credit-card flexy-price"></i> <span>بعد فليكسي:</span> ${formatNumber(productPrice)} × 0.82 = ${formatNumber(netAmount)} دينار</div>
                    <div><i class="fas fa-tag"></i> <span>المبلغ الصافي:</span> ${formatNumber(netAmount)} دينار</div>
                    <div class="profit-display"><i class="fas fa-money-bill"></i> الربح الفعلي: ${formatNumber(profit)} دينار</div>
                `;
            } else {
                // حساب عادي - كما كان
                let cost = usdPrice * rate;
                let profit = productPrice - cost;
                
                document.getElementById('profitCalculation').innerHTML = `
                    <div><i class="fas fa-money-bill-wave normal-price"></i> <span class="normal-price">التكلفة:</span> ${formatNumber(cost)} دينار</div>
                    <div><i class="fas fa-tag"></i> <span>سعر المنتج:</span> ${formatNumber(productPrice)} دينار</div>
                    <div class="profit-display"><i class="fas fa-money-bill"></i> الربح: ${formatNumber(profit)} دينار</div>
                `;
            }
        }
        
        function addTransaction() {
            const usdPrice = parseFloat(document.getElementById('usdPrice').value);
            const productPrice = parseFloat(document.getElementById('productPrice').value);
            const productName = document.getElementById('productName').value.trim();
            
            if (!usdPrice || !productPrice || !productName) {
                showToast('⚠️ أدخل جميع البيانات', 'error');
                return;
            }
            
            let cost, profit;
            
            if (paymentType === 'flexy') {
                // حساب فليكسي حسب الطريقة الجديدة والصحيحة
                // 1. تكلفة المنتج بالدينار
                cost = usdPrice * exchangeRate;
                
                // 2. المبلغ الصافي بعد خصم فليكسي 18% (ضرب في 0.82)
                const netAmount = productPrice * 0.82;
                
                // 3. الربح النهائي
                profit = netAmount - cost;
            } else {
                // حساب عادي
                cost = usdPrice * exchangeRate;
                profit = productPrice - cost;
            }
            
            const now = new Date();
            const timestamp = now.getTime();
            const date = formatDate(timestamp);
            
            const transaction = {
                id: timestamp,
                productName: productName,
                type: paymentType,
                usdPrice: usdPrice,
                cost: cost,
                productPrice: productPrice,
                profit: profit,
                additionalProfits: [],
                date: date,
                timestamp: timestamp,
                selected: false
            };
            
            // إضافة في بداية المصفوفة للحصول على الأحدث أولاً
            transactions.unshift(transaction);
            saveSalesData();
            updateSales();
            
            document.getElementById('productName').value = '';
            document.getElementById('usdPrice').value = '';
            document.getElementById('productPrice').value = '';
            
            showToast(`✅ تمت إضافة "${productName}" بنجاح!`, 'success');
        }
        
        function updateSales() {
            updateSalesStatistics();
            updateTransactionsTable();
        }
        
        function updateSalesStatistics() {
            const now = new Date();
            const today = formatDate(now.getTime());
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let stats = {
                dailyProfit: 0,
                monthlyProfit: 0,
                normalSales: 0,
                flexySales: 0,
                dailyCount: 0,
                monthlyCount: 0,
                normalCount: 0,
                flexyCount: 0
            };
            
            transactions.forEach(t => {
                const totalProfit = t.profit + (t.additionalProfits?.reduce((sum, p) => sum + p.amount, 0) || 0);
                const date = new Date(t.timestamp);
                
                // حساب اليومي - باستخدام الصيغة YYYY/MM/DD للمقارنة
                if (formatDate(t.timestamp) === today) {
                    stats.dailyProfit += totalProfit;
                    stats.dailyCount++;
                }
                
                // حساب الشهري - المقارنة بالشهر والسنة
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    stats.monthlyProfit += totalProfit;
                    stats.monthlyCount++;
                }
                
                if (t.type === 'normal') {
                    stats.normalSales += t.productPrice;
                    stats.normalCount++;
                } else {
                    stats.flexySales += t.productPrice;
                    stats.flexyCount++;
                }
            });
            
            // تحديث الإحصائيات
            document.getElementById('dailyProfit').textContent = formatNumber(stats.dailyProfit) + ' دينار';
            document.getElementById('monthlyProfit').textContent = formatNumber(stats.monthlyProfit) + ' دينار';
            document.getElementById('normalSales').textContent = formatNumber(stats.normalSales) + ' دينار';
            document.getElementById('flexySales').textContent = formatNumber(stats.flexySales) + ' دينار';
            document.getElementById('dailyCount').textContent = stats.dailyCount + ' عملية اليوم';
            document.getElementById('monthlyCount').textContent = stats.monthlyCount + ' عملية هذا الشهر';
            document.getElementById('normalCount').textContent = stats.normalCount + ' عملية بيع';
            document.getElementById('flexyCount').textContent = stats.flexyCount + ' عملية بيع';
        }
        
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ترتيب العمليات من الأحدث إلى الأقدم حسب timestamp
            const sortedTransactions = [...transactions].sort((a, b) => {
                if (salesSortColumn === 'timestamp') {
                    return salesSortDirection === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
                } else if (salesSortColumn === 'productName') {
                    return salesSortDirection === 'asc' 
                        ? a.productName.localeCompare(b.productName)
                        : b.productName.localeCompare(a.productName);
                } else if (salesSortColumn === 'profit') {
                    const aProfit = a.profit + (a.additionalProfits?.reduce((sum, p) => sum + p.amount, 0) || 0);
                    const bProfit = b.profit + (b.additionalProfits?.reduce((sum, p) => sum + p.amount, 0) || 0);
                    return salesSortDirection === 'asc' ? aProfit - bProfit : bProfit - aProfit;
                } else if (salesSortColumn === 'date') {
                    return salesSortDirection === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
                }
                return 0;
            });
            
            sortedTransactions.forEach(t => {
                const totalProfit = t.profit + (t.additionalProfits?.reduce((sum, p) => sum + p.amount, 0) || 0);
                const profitClass = totalProfit >= 0 ? 'green-text' : 'red-text';
                const profitSign = totalProfit >= 0 ? '+' : '';
                const hasAdditional = t.additionalProfits?.length > 0;
                
                const row = `
                    <tr class="${t.type === 'normal' ? 'normal' : 'flexy'} ${t.selected ? 'selected' : ''}">
                        <td><input type="checkbox" class="select-checkbox" ${t.selected ? 'checked' : ''} onchange="toggleSelect(${t.id})"></td>
                        <td>
                            <span class="product-badge" onclick="openEditProductModal(${t.id})">
                                ${t.productName}
                                ${hasAdditional ? ` <small>(+${t.additionalProfits.length})</small>` : ''}
                            </span>
                        </td>
                        <td><span class="type-badge type-${t.type}">${t.type === 'normal' ? 'عادي' : 'فليكسي'}</span></td>
                        <td>${t.usdPrice} $</td>
                        <td>${formatNumber(t.cost)} دينار</td>
                        <td>${formatNumber(t.productPrice)} دينار</td>
                        <td class="profit-cell" onclick="showProfitMenu(${t.id}, event)">
                            <span class="${profitClass}">${profitSign}${formatNumber(totalProfit)} دينار</span>
                            ${hasAdditional ? ' 💰' : ''}
                        </td>
                        <td class="date-cell">${t.date}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="openEditProductModal(${t.id})" title="تعديل المنتج">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn profit-btn" onclick="addNewProfit(${t.id})" title="إضافة ربح">
                                    <i class="fas fa-money-bill"></i> ربح
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteTransaction(${t.id})" title="حذف العملية">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // === وظائف إضافة ربح جديد ===
        function addNewProfit(id) {
            currentTransactionId = id;
            const transaction = transactions.find(t => t.id === id);
            
            const totalProfit = transaction.profit + (transaction.additionalProfits?.reduce((sum, p) => sum + p.amount, 0) || 0);
            
            document.getElementById('addProfitModalContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label>اسم المنتج:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${transaction.productName}</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>الربح الحالي:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${formatNumber(totalProfit)} دينار</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>ربح جديد (استخدم + للزيادة و - للنقصان):</label>
                    <input type="text" id="newProfitAmount" placeholder="مثال: +100 أو -50" style="width: 100%; margin-top: 5px;">
                </div>
            `;
            
            document.getElementById('addProfitModal').style.display = 'flex';
            document.getElementById('newProfitAmount').focus();
        }
        
        function saveNewProfit() {
            const input = document.getElementById('newProfitAmount').value.trim();
            if (!input || !currentTransactionId) return;
            
            const transaction = transactions.find(t => t.id === currentTransactionId);
            if (!transaction) return;
            
            let amount = 0;
            
            if (input.startsWith('+')) {
                amount = parseFloat(input.substring(1)) || 0;
            } else if (input.startsWith('-')) {
                amount = -parseFloat(input.substring(1)) || 0;
            } else {
                amount = parseFloat(input) || 0;
            }
            
            if (!isNaN(amount)) {
                if (!transaction.additionalProfits) transaction.additionalProfits = [];
                
                transaction.additionalProfits.push({
                    amount: amount,
                    date: formatDate(Date.now()),
                    timestamp: Date.now()
                });
                
                saveSalesData();
                updateSales();
                closeAddProfitModal();
                
                const action = amount >= 0 ? 'زيادة' : 'نقصان';
                showToast(`✅ تم ${action} الربح بمقدار ${Math.abs(amount)} دينار`, 'success');
            }
        }
        
        function closeAddProfitModal() {
            document.getElementById('addProfitModal').style.display = 'none';
            currentTransactionId = null;
        }
        
        // === وظائف تعديل المنتج (النافذة الجديدة) ===
        function openEditProductModal(id) {
            editingProductId = id;
            const transaction = transactions.find(t => t.id === id);
            
            if (transaction) {
                document.getElementById('editProductNameInput').value = transaction.productName;
                document.getElementById('editProductModal').style.display = 'flex';
                document.getElementById('editProductNameInput').focus();
            }
        }
        
        function saveEditProduct() {
            const newName = document.getElementById('editProductNameInput').value.trim();
            if (!newName || !editingProductId) return;
            
            const transaction = transactions.find(t => t.id === editingProductId);
            if (transaction) {
                transaction.productName = newName;
                saveSalesData();
                updateSales();
                closeEditProductModal();
                showToast('✅ تم تحديث اسم المنتج', 'success');
            }
        }
        
        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            editingProductId = null;
        }
        
        function deleteTransaction(id) {
            if (confirm('هل تريد حذف هذه العملية؟')) {
                transactions = transactions.filter(t => t.id !== id);
                saveSalesData();
                updateSales();
                showToast('✅ تم حذف العملية', 'success');
            }
        }
        
        // === وظائف الربح السريع ===
        function showProfitMenu(id, event) {
            event.preventDefault();
            event.stopPropagation();
            
            currentProfitId = id;
            
            const menu = document.getElementById('profitMenu');
            const cell = event.target.closest('.profit-cell');
            const rect = cell.getBoundingClientRect();
            
            menu.style.display = 'block';
            menu.style.left = (rect.left - 210) + 'px';
            menu.style.top = rect.bottom + 'px';
            menu.classList.add('show');
            
            profitMenuOpen = true;
        }
        
        function hideProfitMenu() {
            const menu = document.getElementById('profitMenu');
            menu.classList.remove('show');
            profitMenuOpen = false;
        }
        
        function addQuickProfit(amount) {
            if (!currentProfitId) return;
            
            const transaction = transactions.find(t => t.id === currentProfitId);
            if (transaction) {
                if (!transaction.additionalProfits) transaction.additionalProfits = [];
                
                transaction.additionalProfits.push({
                    amount: amount,
                    date: formatDate(Date.now()),
                    timestamp: Date.now()
                });
                
                saveSalesData();
                updateSales();
                hideProfitMenu();
                
                const action = amount >= 0 ? 'زيادة' : 'نقصان';
                showToast(`✅ تم ${action} الربح بمقدار ${Math.abs(amount)} دينار`, 'success');
            }
        }
        
        function openCustomProfitModal() {
            hideProfitMenu();
            document.getElementById('customProfitModal').style.display = 'flex';
            document.getElementById('customProfitAmount').focus();
        }
        
        function saveCustomProfit() {
            const input = document.getElementById('customProfitAmount').value.trim();
            if (!input) return;
            
            let amount = 0;
            
            if (input.startsWith('+')) {
                amount = parseFloat(input.substring(1)) || 0;
            } else if (input.startsWith('-')) {
                amount = -parseFloat(input.substring(1)) || 0;
            } else {
                amount = parseFloat(input) || 0;
            }
            
            if (!isNaN(amount)) {
                addQuickProfit(amount);
                closeCustomProfitModal();
            }
        }
        
        function closeCustomProfitModal() {
            document.getElementById('customProfitModal').style.display = 'none';
            document.getElementById('customProfitAmount').value = '';
        }
        
        // === وظائف زر المزيد ===
        function toggleMoreOptions(type) {
            const salesOptions = document.getElementById('salesMoreOptions');
            const debtsOptions = document.getElementById('debtsMoreOptions');
            const subscriptionsOptions = document.getElementById('subscriptionsMoreOptions');
            
            // إغلاق جميع القوائم أولاً
            salesOptions.classList.remove('show');
            debtsOptions.classList.remove('show');
            subscriptionsOptions.classList.remove('show');
            
            // فتح القائمة المطلوبة
            if (type === 'sales') {
                salesOptions.classList.toggle('show');
            } else if (type === 'debts') {
                debtsOptions.classList.toggle('show');
            } else if (type === 'subscriptions') {
                subscriptionsOptions.classList.toggle('show');
            }
        }
        
        // === وظائف التصدير والاستيراد ===
        function exportSalesData() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `GazanSystem-sales-${formatDate(Date.now()).replace(/\//g, '-')}.json`);
            link.click();
            
            showToast('✅ تم تصدير بيانات المبيعات', 'success');
            document.getElementById('salesMoreOptions').classList.remove('show');
        }
        
        function importSalesData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // التحقق من صحة البيانات
                        if (!Array.isArray(importedData)) {
                            throw new Error('صيغة الملف غير صحيحة');
                        }
                        
                        // دمج البيانات المستوردة مع البيانات الحالية
                        transactions = [...importedData, ...transactions];
                        saveSalesData();
                        updateSales();
                        
                        showToast(`✅ تم استيراد ${importedData.length} عملية مبيعات`, 'success');
                        document.getElementById('salesMoreOptions').classList.remove('show');
                    } catch (error) {
                        showToast('❌ خطأ في استيراد البيانات: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportDebts() {
            const dataStr = JSON.stringify(debts, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `GazanSystem-debts-${formatDate(Date.now()).replace(/\//g, '-')}.json`);
            link.click();
            
            showToast('✅ تم تصدير بيانات الديون', 'success');
            document.getElementById('debtsMoreOptions').classList.remove('show');
        }
        
        function importDebts() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // التحقق من صحة البيانات
                        if (!Array.isArray(importedData)) {
                            throw new Error('صيغة الملف غير صحيحة');
                        }
                        
                        // دمج البيانات المستوردة مع البيانات الحالية
                        debts = [...importedData, ...debts];
                        saveDebtsData();
                        updateDebts();
                        
                        showToast(`✅ تم استيراد ${importedData.length} دين`, 'success');
                        document.getElementById('debtsMoreOptions').classList.remove('show');
                    } catch (error) {
                        showToast('❌ خطأ في استيراد البيانات: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // === وظائف المديونين ===
        function addDebt() {
            const name = document.getElementById('debtorName').value.trim();
            const amount = parseFloat(document.getElementById('debtAmount').value);
            
            if (!name || !amount) {
                showToast('⚠️ أدخل اسم المديون والمبلغ', 'error');
                return;
            }
            
            const timestamp = Date.now();
            const debt = {
                id: timestamp,
                name: name,
                amount: amount,
                date: formatDate(timestamp),
                timestamp: timestamp
            };
            
            // إضافة في بداية المصفوفة للحصول على الأحدث أولاً
            debts.unshift(debt);
            saveDebtsData();
            updateDebts();
            
            document.getElementById('debtorName').value = '';
            document.getElementById('debtAmount').value = '';
            
            showToast(`✅ تم إضافة مديون جديد: ${name}`, 'success');
        }
        
        function updateDebts() {
            updateDebtsStatistics();
            updateDebtsTable();
            checkForZeroDebts();
        }
        
        function updateDebtsStatistics() {
            const activeDebts = debts.filter(d => d.amount > 0);
            const totalDebtors = activeDebts.length;
            const totalDebts = activeDebts.reduce((sum, d) => sum + d.amount, 0);
            const averageDebt = totalDebtors > 0 ? totalDebts / totalDebtors : 0;
            
            document.getElementById('totalDebtors').textContent = totalDebtors + ' شخص';
            document.getElementById('totalDebts').textContent = formatNumber(totalDebts) + ' دينار';
            document.getElementById('averageDebt').textContent = formatNumber(averageDebt) + ' متوسط الدين';
            document.getElementById('activeDebts').textContent = totalDebtors + ' دين نشط';
            document.getElementById('paidCount').textContent = paidDebtsCount + ' دين مسدد';
        }
        
        function updateDebtsTable() {
            const tbody = document.getElementById('debtsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ترتيب الديون من الأحدث إلى الأقدم
            const sortedDebts = [...debts].sort((a, b) => {
                if (debtSortColumn === 'timestamp') {
                    return debtSortDirection === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
                } else if (debtSortColumn === 'name') {
                    return debtSortDirection === 'asc' 
                        ? a.name.localeCompare(b.name)
                        : b.name.localeCompare(a.name);
                } else if (debtSortColumn === 'amount') {
                    return debtSortDirection === 'asc' ? a.amount - b.amount : b.amount - a.amount;
                } else if (debtSortColumn === 'date') {
                    return debtSortDirection === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
                }
                return 0;
            });
            
            sortedDebts.forEach((d, index) => {
                const isPaid = d.amount <= 0;
                const badgeClass = isPaid ? 'paid' : '';
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <span class="debtor-badge ${badgeClass}" onclick="openEditDebtorModal(${d.id})">
                                ${d.name}
                                ${isPaid ? ' (مسدد)' : ''}
                            </span>
                        </td>
                        <td class="amount-cell" onclick="updateDebtAmount(${d.id})">
                            ${formatNumber(d.amount)} دينار
                        </td>
                        <td class="date-cell">${d.date}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="openEditDebtorModal(${d.id})" title="تعديل الاسم">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn update-btn" onclick="updateDebtAmount(${d.id})" title="تحديث المبلغ">
                                    <i class="fas fa-exchange-alt"></i> تحديث
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteDebt(${d.id})" title="حذف الدين">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // === وظائف تعديل المديونين (النافذة الجديدة) ===
        function openEditDebtorModal(id) {
            editingDebtorId = id;
            const debtor = debts.find(d => d.id === id);
            
            if (debtor) {
                document.getElementById('editDebtorNameInput').value = debtor.name;
                document.getElementById('editDebtorModal').style.display = 'flex';
                document.getElementById('editDebtorNameInput').focus();
            }
        }
        
        function saveEditDebtor() {
            const newName = document.getElementById('editDebtorNameInput').value.trim();
            if (!newName || !editingDebtorId) return;
            
            const debtor = debts.find(d => d.id === editingDebtorId);
            if (debtor) {
                debtor.name = newName;
                saveDebtsData();
                updateDebts();
                closeEditDebtorModal();
                showToast('✅ تم تحديث اسم المديون', 'success');
            }
        }
        
        function closeEditDebtorModal() {
            document.getElementById('editDebtorModal').style.display = 'none';
            editingDebtorId = null;
        }
        
        // === خاصية الحذف التلقائي عند وصول الدين للصفر ===
        function checkForZeroDebts() {
            let deletedCount = 0;
            
            // التحقق من الديون التي وصلت للصفر
            debts.forEach(debt => {
                if (debt.amount <= 0 && !debt.markedForDeletion) {
                    debt.markedForDeletion = true;
                    deletedCount++;
                    paidDebtsCount++;
                }
            });
            
            // حذف الديون المعلومة بعد فترة وجيزة
            if (deletedCount > 0) {
                setTimeout(() => {
                    debts = debts.filter(d => d.amount > 0);
                    saveDebtsData();
                    updateDebts();
                    if (deletedCount > 0) {
                        showToast(`✅ تم حذف ${deletedCount} دين وصل مبلغه للصفر`, 'success');
                    }
                }, 500);
            }
        }
        
        function updateDebtAmount(id) {
            currentDebtorId = id;
            const debt = debts.find(d => d.id === id);
            
            document.getElementById('updateDebtModalContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label>المديون:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${debt.name}</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>المبلغ الحالي:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${formatNumber(debt.amount)} دينار</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>تحديث المبلغ (استخدم + للزيادة و - للنقصان):</label>
                    <input type="text" id="debtUpdateAmount" placeholder="مثال: +100 أو -50 أو 200" style="width: 100%; margin-top: 5px;">
                </div>
            `;
            
            document.getElementById('updateDebtModal').style.display = 'flex';
            document.getElementById('debtUpdateAmount').focus();
        }
        
        function saveDebtUpdate() {
            const input = document.getElementById('debtUpdateAmount').value.trim();
            if (!input || !currentDebtorId) return;
            
            const debt = debts.find(d => d.id === currentDebtorId);
            if (!debt) return;
            
            let newAmount = debt.amount;
            
            if (input.startsWith('+')) {
                const amount = parseFloat(input.substring(1)) || 0;
                newAmount = debt.amount + amount;
            } else if (input.startsWith('-')) {
                const amount = parseFloat(input.substring(1)) || 0;
                newAmount = debt.amount - amount;
            } else {
                newAmount = parseFloat(input) || debt.amount;
            }
            
            if (!isNaN(newAmount)) {
                debt.amount = newAmount;
                saveDebtsData();
                updateDebts();
                closeUpdateDebtModal();
                showToast('✅ تم تحديث مبلغ الدين', 'success');
            }
        }
        
        function closeUpdateDebtModal() {
            document.getElementById('updateDebtModal').style.display = 'none';
            currentDebtorId = null;
        }
        
        function deleteDebt(id) {
            if (confirm('هل تريد حذف هذا الدين؟')) {
                debts = debts.filter(d => d.id !== id);
                saveDebtsData();
                updateDebts();
                showToast('✅ تم حذف الدين', 'success');
            }
        }
        
        function clearAllDebts() {
            if (confirm('⚠️ هل تريد مسح جميع الديون؟ لا يمكن التراجع عن هذا الإجراء.')) {
                debts = [];
                paidDebtsCount = 0;
                saveDebtsData();
                updateDebts();
                showToast('🗑️ تم مسح جميع الديون', 'success');
            }
        }
        
        function clearSalesData() {
            if (confirm('⚠️ هل تريد مسح جميع بيانات المبيعات؟ لا يمكن التراجع عن هذا الإجراء.')) {
                transactions = [];
                saveSalesData();
                updateSales();
                showToast('🗑️ تم مسح جميع بيانات المبيعات', 'success');
            }
        }
        
        // === وظائف الاشتراكات ===
        function selectDuration(duration) {
            subscriptionDuration = duration;
            document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
            document.getElementById('duration' + duration + 'Option').classList.add('selected');
            document.getElementById('duration' + duration).checked = true;
            updateSubscriptionDates();
        }
        
        function updateSubscriptionDates() {
            const now = new Date();
            const startDate = formatDate(now.getTime());
            
            const endDate = new Date(now);
            endDate.setMonth(endDate.getMonth() + subscriptionDuration);
            const endDateFormatted = formatDate(endDate.getTime());
            
            document.getElementById('subscriptionDatesDisplay').innerHTML = `
                <div class="info-price">
                    <i class="fas fa-calendar-day"></i> تاريخ البدء: ${startDate}
                </div>
                <div class="info-price">
                    <i class="fas fa-calendar-times"></i> تاريخ الانتهاء: ${endDateFormatted}
                </div>
                <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                    المدة: ${getDurationText(subscriptionDuration)}
                </div>
            `;
        }
        
        function getDurationText(duration) {
            switch(duration) {
                case 1: return 'شهر واحد';
                case 2: return 'شهرين';
                case 3: return '3 أشهر';
                case 6: return '6 أشهر';
                case 12: return 'سنة كاملة';
                default: return `${duration} شهر`;
            }
        }
        
        function addSubscription() {
            const subscriptionName = document.getElementById('subscriptionName').value.trim();
            const subscriberName = document.getElementById('subscriberName').value.trim();
            
            if (!subscriptionName || !subscriberName) {
                showToast('⚠️ أدخل جميع بيانات الاشتراك', 'error');
                return;
            }
            
            const now = new Date();
            const startDate = new Date();
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + subscriptionDuration);
            
            const timestamp = now.getTime();
            const subscription = {
                id: timestamp,
                subscriptionName: subscriptionName,
                subscriberName: subscriberName,
                duration: subscriptionDuration,
                durationText: getDurationText(subscriptionDuration),
                startDate: formatDate(startDate.getTime()),
                endDate: formatDate(endDate.getTime()),
                startTimestamp: startDate.getTime(),
                endTimestamp: endDate.getTime(),
                date: formatDate(timestamp),
                timestamp: timestamp,
                status: 'active'
            };
            
            // تحديث حالة الاشتراك بناءً على تاريخ الانتهاء
            updateSubscriptionStatus(subscription);
            
            // إضافة في بداية المصفوفة للحصول على الأحدث أولاً
            subscriptions.unshift(subscription);
            saveSubscriptionsData();
            updateSubscriptions();
            
            // مسح الحقول
            document.getElementById('subscriptionName').value = '';
            document.getElementById('subscriberName').value = '';
            
            showToast(`✅ تم إضافة اشتراك ${subscriptionName} للمشترك ${subscriberName}`, 'success');
        }
        
        function updateSubscriptionStatus(subscription) {
            const now = new Date();
            const endDate = new Date(subscription.endTimestamp);
            const daysRemaining = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
            
            if (daysRemaining < 0) {
                subscription.status = 'expired';
            } else if (daysRemaining <= 7) {
                subscription.status = 'soon';
            } else {
                subscription.status = 'active';
            }
        }
        
        function updateSubscriptions() {
            updateSubscriptionsStatistics();
            updateSubscriptionsTable();
        }
        
        function updateSubscriptionsStatistics() {
            const now = new Date();
            let stats = {
                totalSubscribers: 0,
                activeSubscriptions: 0,
                expiringSoon: 0,
                expiredSubscriptions: 0,
                activeSubsCount: 0
            };
            
            subscriptions.forEach(sub => {
                updateSubscriptionStatus(sub);
                
                stats.totalSubscribers++;
                
                if (sub.status === 'active') {
                    stats.activeSubscriptions++;
                    stats.activeSubsCount++;
                } else if (sub.status === 'soon') {
                    stats.expiringSoon++;
                    stats.activeSubsCount++; // يعتبر نشط لأنه لم ينته بعد
                } else if (sub.status === 'expired') {
                    stats.expiredSubscriptions++;
                }
            });
            
            // تحديث الإحصائيات
            document.getElementById('totalSubscribers').textContent = stats.totalSubscribers + ' مشترك';
            document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions + ' اشتراك نشط';
            document.getElementById('activeSubsCount').textContent = stats.activeSubsCount + ' اشتراك';
            document.getElementById('expiringSoonCount').textContent = stats.expiringSoon + ' اشتراك';
            document.getElementById('expiredSubsCount').textContent = stats.expiredSubscriptions + ' اشتراك';
        }
        
        function updateSubscriptionsTable() {
            const tbody = document.getElementById('subscriptionsBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // ترتيب الاشتراكات من الأحدث إلى الأقدم
            const sortedSubscriptions = [...subscriptions].sort((a, b) => {
                if (subscriptionSortColumn === 'timestamp') {
                    return subscriptionSortDirection === 'asc' ? a.timestamp - b.timestamp : b.timestamp - a.timestamp;
                } else if (subscriptionSortColumn === 'subscriptionName') {
                    return subscriptionSortDirection === 'asc' 
                        ? a.subscriptionName.localeCompare(b.subscriptionName)
                        : b.subscriptionName.localeCompare(a.subscriptionName);
                } else if (subscriptionSortColumn === 'subscriberName') {
                    return subscriptionSortDirection === 'asc' 
                        ? a.subscriberName.localeCompare(b.subscriberName)
                        : b.subscriberName.localeCompare(a.subscriberName);
                } else if (subscriptionSortColumn === 'endDate') {
                    return subscriptionSortDirection === 'asc' ? a.endTimestamp - b.endTimestamp : b.endTimestamp - a.endTimestamp;
                } else if (subscriptionSortColumn === 'status') {
                    const statusOrder = { 'active': 1, 'soon': 2, 'expired': 3 };
                    return subscriptionSortDirection === 'asc' 
                        ? statusOrder[a.status] - statusOrder[b.status]
                        : statusOrder[b.status] - statusOrder[a.status];
                }
                return 0;
            });
            
            sortedSubscriptions.forEach((sub, index) => {
                const statusText = sub.status === 'active' ? 'نشط' : sub.status === 'soon' ? 'قريب الانتهاء' : 'منتهي';
                const statusClass = sub.status === 'active' ? 'status-active' : sub.status === 'soon' ? 'status-soon' : 'status-expired';
                const durationClass = 'duration-' + sub.duration;
                
                const row = `
                    <tr class="subscription-row">
                        <td>${index + 1}</td>
                        <td>
                            <span class="subscription-badge" onclick="openEditSubscriptionModal(${sub.id})">
                                ${sub.subscriptionName}
                            </span>
                        </td>
                        <td>
                            <span class="debtor-badge" onclick="openEditSubscriberModal(${sub.id})">
                                ${sub.subscriberName}
                            </span>
                        </td>
                        <td><span class="duration-badge ${durationClass}">${sub.durationText}</span></td>
                        <td class="date-cell" onclick="openEditSubscriptionDatesModal(${sub.id})">${sub.startDate}</td>
                        <td class="date-cell" onclick="openEditSubscriptionDatesModal(${sub.id})">${sub.endDate}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="openEditSubscriptionModal(${sub.id})" title="تعديل الاشتراك">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button class="action-btn renew-btn" onclick="renewSubscription(${sub.id})" title="تجديد الاشتراك">
                                    <i class="fas fa-redo"></i> تجديد
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteSubscription(${sub.id})" title="حذف الاشتراك">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // === وظائف تعديل الاشتراكات (النوافذ الجديدة) ===
        function openEditSubscriptionModal(id) {
            editingSubscriptionId = id;
            const subscription = subscriptions.find(s => s.id === id);
            
            if (subscription) {
                document.getElementById('editSubscriptionNameInput').value = subscription.subscriptionName;
                document.getElementById('editSubscriptionModal').style.display = 'flex';
                document.getElementById('editSubscriptionNameInput').focus();
            }
        }
        
        function saveEditSubscription() {
            const newName = document.getElementById('editSubscriptionNameInput').value.trim();
            if (!newName || !editingSubscriptionId) return;
            
            const subscription = subscriptions.find(s => s.id === editingSubscriptionId);
            if (subscription) {
                subscription.subscriptionName = newName;
                saveSubscriptionsData();
                updateSubscriptions();
                closeEditSubscriptionModal();
                showToast('✅ تم تحديث اسم الاشتراك', 'success');
            }
        }
        
        function closeEditSubscriptionModal() {
            document.getElementById('editSubscriptionModal').style.display = 'none';
            editingSubscriptionId = null;
        }
        
        function openEditSubscriberModal(id) {
            editingSubscriberId = id;
            const subscription = subscriptions.find(s => s.id === id);
            
            if (subscription) {
                document.getElementById('editSubscriberNameInput').value = subscription.subscriberName;
                document.getElementById('editSubscriberModal').style.display = 'flex';
                document.getElementById('editSubscriberNameInput').focus();
            }
        }
        
        function saveEditSubscriber() {
            const newName = document.getElementById('editSubscriberNameInput').value.trim();
            if (!newName || !editingSubscriberId) return;
            
            const subscription = subscriptions.find(s => s.id === editingSubscriberId);
            if (subscription) {
                subscription.subscriberName = newName;
                saveSubscriptionsData();
                updateSubscriptions();
                closeEditSubscriberModal();
                showToast('✅ تم تحديث اسم المشترك', 'success');
            }
        }
        
        function closeEditSubscriberModal() {
            document.getElementById('editSubscriberModal').style.display = 'none';
            editingSubscriberId = null;
        }
        
        function openEditSubscriptionDatesModal(id) {
            editingSubscriptionDatesId = id;
            const subscription = subscriptions.find(s => s.id === id);
            
            if (subscription) {
                document.getElementById('editStartDateInput').value = subscription.startDate;
                document.getElementById('editDurationInput').value = subscription.duration;
                updateCalculatedEndDate();
                document.getElementById('editSubscriptionDatesModal').style.display = 'flex';
                document.getElementById('editStartDateInput').focus();
            }
        }
        
        function updateCalculatedEndDate() {
            const startDateStr = document.getElementById('editStartDateInput').value;
            const duration = parseInt(document.getElementById('editDurationInput').value);
            
            if (!startDateStr || !duration) return;
            
            // تحويل تاريخ البداية إلى كائن Date
            const parts = startDateStr.split('/');
            if (parts.length !== 3) return;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; // الأشهر من 0-11 في JavaScript
            const day = parseInt(parts[2]);
            
            const startDate = new Date(year, month, day);
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + duration);
            
            document.getElementById('calculatedEndDate').textContent = formatDate(endDate.getTime());
        }
        
        function saveEditSubscriptionDates() {
            const startDateStr = document.getElementById('editStartDateInput').value;
            const duration = parseInt(document.getElementById('editDurationInput').value);
            
            if (!startDateStr || !duration || !editingSubscriptionDatesId) return;
            
            const subscription = subscriptions.find(s => s.id === editingSubscriptionDatesId);
            if (!subscription) return;
            
            // تحقق من صحة تاريخ البداية
            const parts = startDateStr.split('/');
            if (parts.length !== 3) {
                showToast('❌ صيغة التاريخ غير صحيحة. استخدم YYYY/MM/DD', 'error');
                return;
            }
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const day = parseInt(parts[2]);
            
            const startDate = new Date(year, month, day);
            if (isNaN(startDate.getTime())) {
                showToast('❌ تاريخ غير صالح', 'error');
                return;
            }
            
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + duration);
            
            subscription.startDate = formatDate(startDate.getTime());
            subscription.endDate = formatDate(endDate.getTime());
            subscription.startTimestamp = startDate.getTime();
            subscription.endTimestamp = endDate.getTime();
            subscription.duration = duration;
            subscription.durationText = getDurationText(duration);
            
            // تحديث الحالة بناءً على التاريخ الجديد
            updateSubscriptionStatus(subscription);
            
            saveSubscriptionsData();
            updateSubscriptions();
            closeEditSubscriptionDatesModal();
            showToast('✅ تم تحديث تواريخ الاشتراك', 'success');
        }
        
        function closeEditSubscriptionDatesModal() {
            document.getElementById('editSubscriptionDatesModal').style.display = 'none';
            editingSubscriptionDatesId = null;
        }
        
        function renewSubscription(id) {
            currentSubscriptionId = id;
            const subscription = subscriptions.find(s => s.id === id);
            
            document.getElementById('renewSubscriptionModalContent').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <label>الاشتراك:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${subscription.subscriptionName}</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>المشترك:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${subscription.subscriberName}</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>تاريخ الانتهاء الحالي:</label>
                    <div style="background: var(--border); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>${subscription.endDate}</strong>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label>المدة الجديدة:</label>
                    <select id="renewDuration" style="width: 100%; margin-top: 5px;">
                        <option value="1">شهر واحد</option>
                        <option value="2">شهرين</option>
                        <option value="3">3 أشهر</option>
                        <option value="6">6 أشهر</option>
                        <option value="12">سنة كاملة</option>
                    </select>
                </div>
            `;
            
            document.getElementById('renewSubscriptionModal').style.display = 'flex';
            document.getElementById('renewDuration').focus();
        }
        
        function saveRenewal() {
            const duration = parseInt(document.getElementById('renewDuration').value);
            
            if (!duration || !currentSubscriptionId) return;
            
            const subscription = subscriptions.find(s => s.id === currentSubscriptionId);
            if (!subscription) return;
            
            // تجديد الاشتراك - إضافة مدة جديدة إلى تاريخ الانتهاء الحالي
            const currentEndDate = new Date(subscription.endTimestamp);
            currentEndDate.setMonth(currentEndDate.getMonth() + duration);
            
            subscription.duration = duration;
            subscription.durationText = getDurationText(duration);
            subscription.endDate = formatDate(currentEndDate.getTime());
            subscription.endTimestamp = currentEndDate.getTime();
            
            // تحديث الحالة
            updateSubscriptionStatus(subscription);
            
            saveSubscriptionsData();
            updateSubscriptions();
            closeRenewSubscriptionModal();
            
            showToast(`✅ تم تجديد اشتراك ${subscription.subscriptionName} لمدة ${getDurationText(duration)}`, 'success');
        }
        
        function closeRenewSubscriptionModal() {
            document.getElementById('renewSubscriptionModal').style.display = 'none';
            currentSubscriptionId = null;
        }
        
        function deleteSubscription(id) {
            if (confirm('هل تريد حذف هذا الاشتراك؟')) {
                subscriptions = subscriptions.filter(s => s.id !== id);
                saveSubscriptionsData();
                updateSubscriptions();
                showToast('✅ تم حذف الاشتراك', 'success');
            }
        }
        
        function clearAllSubscriptions() {
            if (confirm('⚠️ هل تريد مسح جميع الاشتراكات؟ لا يمكن التراجع عن هذا الإجراء.')) {
                subscriptions = [];
                saveSubscriptionsData();
                updateSubscriptions();
                showToast('🗑️ تم مسح جميع الاشتراكات', 'success');
            }
        }
        
        function filterSubscriptionsTable() {
            const search = document.getElementById('subscriptionSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#subscriptionsBody tr');
            
            rows.forEach(row => {
                const subscriptionName = row.querySelector('.subscription-badge')?.textContent?.toLowerCase() || '';
                const subscriberName = row.querySelector('.debtor-badge')?.textContent?.toLowerCase() || '';
                if (subscriptionName.includes(search) || subscriberName.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function sortSubscriptionsTable(column) {
            if (subscriptionSortColumn === column) {
                subscriptionSortDirection = subscriptionSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                subscriptionSortColumn = column;
                subscriptionSortDirection = 'desc';
            }
            updateSubscriptionsTable();
        }
        
        function exportSubscriptions() {
            const dataStr = JSON.stringify(subscriptions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `GazanSystem-subscriptions-${formatDate(Date.now()).replace(/\//g, '-')}.json`);
            link.click();
            
            showToast('✅ تم تصدير بيانات الاشتراكات', 'success');
            document.getElementById('subscriptionsMoreOptions').classList.remove('show');
        }
        
        function importSubscriptions() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // التحقق من صحة البيانات
                        if (!Array.isArray(importedData)) {
                            throw new Error('صيغة الملف غير صحيحة');
                        }
                        
                        // دمج البيانات المستوردة مع البيانات الحالية
                        subscriptions = [...importedData, ...subscriptions];
                        saveSubscriptionsData();
                        updateSubscriptions();
                        
                        showToast(`✅ تم استيراد ${importedData.length} اشتراك`, 'success');
                        document.getElementById('subscriptionsMoreOptions').classList.remove('show');
                    } catch (error) {
                        showToast('❌ خطأ في استيراد البيانات: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // === وظائف مساعدة ===
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        function saveSalesData() {
            localStorage.setItem('salesTransactions', JSON.stringify(transactions));
        }
        
        function saveDebtsData() {
            localStorage.setItem('debtsData', JSON.stringify(debts));
        }
        
        function saveSubscriptionsData() {
            localStorage.setItem('subscriptionsData', JSON.stringify(subscriptions));
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('en-US');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = { 
                success: 'fa-check-circle', 
                error: 'fa-exclamation-circle', 
                info: 'fa-info-circle', 
                warning: 'fa-exclamation-triangle' 
            };
            
            toast.innerHTML = `<i class="fas ${icons[type]}"></i> ${message}`;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
        
        function toggleTheme() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            document.querySelector('.theme-toggle i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            showToast(isDarkMode ? 'تم تفعيل الوضع الليلي 🌙' : 'تم تفعيل الوضع النهاري ☀️', 'info');
        }
        
        function loadThemePreference() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.querySelector('.theme-toggle i').className = 'fas fa-sun';
            }
        }
        
        // === وظائف إضافية ===
        function toggleSelect(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) transaction.selected = !transaction.selected;
            updateTransactionsTable();
        }
        
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            transactions.forEach(t => t.selected = checked);
            updateTransactionsTable();
        }
        
        function deleteSelectedSales() {
            const selected = transactions.filter(t => t.selected);
            if (selected.length === 0) {
                showToast('⚠️ لم يتم تحديد أي عمليات', 'warning');
                return;
            }
            
            if (confirm(`هل تريد حذف ${selected.length} عملية؟`)) {
                transactions = transactions.filter(t => !t.selected);
                saveSalesData();
                updateSales();
                showToast(`✅ تم حذف ${selected.length} عملية`, 'success');
            }
        }
        
        function filterSalesTable() {
            const search = document.getElementById('salesSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#transactionsBody tr');
            
            rows.forEach(row => {
                const productName = row.querySelector('.product-badge')?.textContent?.toLowerCase() || '';
                if (productName.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function filterDebtsTable() {
            const search = document.getElementById('debtSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#debtsBody tr');
            
            rows.forEach(row => {
                const debtorName = row.querySelector('.debtor-badge')?.textContent?.toLowerCase() || '';
                if (debtorName.includes(search)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function sortSalesTable(column) {
            if (salesSortColumn === column) {
                salesSortDirection = salesSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                salesSortColumn = column;
                salesSortDirection = 'desc';
            }
            updateTransactionsTable();
        }
        
        function sortDebtsTable(column) {
            if (debtSortColumn === column) {
                debtSortDirection = debtSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                debtSortColumn = column;
                debtSortDirection = 'desc';
            }
            updateDebtsTable();
        }
        
        console.log("🎯 Gazan System مع جميع التحديثات جاهز!");
    </script>
</body>
</html>